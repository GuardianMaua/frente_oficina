<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invasão de dados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #1a202c;
        color: #e2e8f0;
        min-height: 100vh;
      }
      .container-box {
        background-color: #2d3748;
        border: 1px solid #4a5568;
      }
      .data-viewer {
        background-color: #1e293b;
        color: #68d391;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 150px;
      }
      .btn-primary {
        transition: all 0.2s;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="p-4 flex items-start justify-center">
    <div class="w-full max-w-4xl space-y-8 mt-10">
      <header class="text-center">
        <h1 class="text-4xl font-extrabold text-blue-400 mb-2">
          Invasão de Dados: A Fuga do ReAniman
        </h1>
      </header>

      <div class="container-box p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
        <section>
          <h2
            class="text-2xl font-bold text-gray-200 mb-4 border-b border-gray-600 pb-2"
          >
            Painel de Acesso de Dados
          </h2>
          <p class="text-center">
            Com a ameaça Viltrumita, a GDA criou perfis secretos para robôs
            ReAniman, para monitorar sua lealdade. O sistema está configurado
            para mostrar os dados do ID inserido. Use a vulnerabilidade para
            acessar o perfil correto.
          </p>

          <div class="flex flex-col md:flex-row gap-4 mb-6 items-end">
            <div class="flex-grow w-full">
              <label
                for="userIdInput"
                class="block text-sm font-medium text-gray-400 mb-1"
                >ID do Agente a Consultar:</label
              >
              <input
                type="text"
                id="userIdInput"
                value="USER/1"
                class="w-full p-3 rounded-lg bg-gray-700 text-yellow-300 border border-gray-600 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Ex: USER_1"
              />
            </div>
            <button
              id="fetchDataButton"
              onclick="fetchPrivateData()"
              class="btn-primary bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md w-full md:w-auto"
            >
              <svg
                class="inline w-5 h-5 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                ></path>
              </svg>
              Ver Dados Privados
            </button>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-400 mb-1"
              >Resposta do Servidor (JSON):</label
            >
            <pre
              id="dataViewer"
              class="data-viewer p-4 rounded-lg text-sm overflow-x-auto shadow-inner"
            >
Clique em 'Ver Dados Privados' para carregar a informação do Agente 1.</pre
            >
          </div>
        </section>

        <section>
          <h2
            class="text-2xl font-bold text-gray-200 mb-4 border-b border-gray-600 pb-2"
          >
            Verificação da Chave 04
          </h2>
          <div class="flex flex-col md:flex-row gap-4 items-end">
            <div class="flex-grow w-full">
              <label
                for="flagInput"
                class="block text-sm font-medium text-gray-400 mb-1"
                >CHAVE (Caminho Certo) Encontrada:</label
              >
              <input
                type="text"
                id="flagInput"
                class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-green-500 focus:border-green-500"
              />
            </div>
            <button
              id="submitFlagButton"
              onclick="submitFlag()"
              class="px-6 py-3 rounded-lg font-bold bg-green-600 hover:bg-green-700 text-white transition-all shadow-md hover:shadow-green-500/50 w-full md:w-auto"
            >
              <svg
                class="inline w-5 h-5 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                ></path>
              </svg>
              Enviar Chave
            </button>
          </div>

          <div
            id="statusMessage"
            class="mt-4 p-3 rounded-lg text-center font-medium hidden"
          ></div>
        </section>
      </div>
    </div>

    <script>
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {};
      const authToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      function showStatusMessage(message, type) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = "mt-4 p-3 rounded-lg text-center font-medium";
        statusDiv.classList.remove("hidden");

        switch (type) {
          case "success":
            statusDiv.classList.add("bg-green-700", "text-white");
            break;
          case "error":
            statusDiv.classList.add("bg-red-700", "text-white");
            break;
          case "info":
          default:
            statusDiv.classList.add("bg-blue-700", "text-white");
            break;
        }
      }

      async function fetchWithBackoff(
        url,
        options,
        maxRetries = 3,
        delay = 1000
      ) {
        for (let i = 0; i < maxRetries; i++) {
          try {
            const response = await fetch(url, options);
            if (response.status !== 429) {
              return response;
            }
            console.warn(
              `Tentativa ${i + 1} falhou com 429. Tentando novamente em ${
                delay / 1000
              }s...`
            );
          } catch (error) {
            console.error(`Tentativa ${i + 1} falhou:`, error);
          }
          await new Promise((resolve) => setTimeout(resolve, delay));
          delay *= 2;
        }
        throw new Error("Todas as tentativas de API falharam.");
      }

      async function fetchPrivateData() {
        const userId = document.getElementById("userIdInput").value.trim();
        const dataViewer = document.getElementById("dataViewer");
        dataViewer.textContent = "Carregando dados...";
        showStatusMessage("Consultando dados para Agente: " + userId, "info");

        const url = `/dados-privados?id=${userId}`;

        try {
          const response = await fetchWithBackoff(url, { method: "GET" });
          const data = await response.json();

          if (response.ok) {
            dataViewer.textContent = JSON.stringify(data, null, 2);
            showStatusMessage(
              `Dados do Agente ${userId} carregados com sucesso.`,
              "success"
            );
          } else {
            dataViewer.textContent = JSON.stringify(data, null, 2);
            showStatusMessage(
              `Erro ao carregar dados: ${data.error || "Erro desconhecido"}`,
              "error"
            );
          }
        } catch (error) {
          console.error("Erro na comunicação com a API de dados:", error);
          dataViewer.textContent = `Erro ao conectar com o servidor: ${error.message}`;
          showStatusMessage("Erro fatal de comunicação com a API.", "error");
        }
      }

      async function submitFlag() {
        const flag = document.getElementById("flagInput").value.trim();
        if (!flag) {
          showStatusMessage("Por favor, insira a chave encontrada.", "error");
          return;
        }

        try {
          const response = await fetchWithBackoff("/verificar-flag-04", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ flag: flag }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showStatusMessage(`${result.message}`, "success");
            setTimeout(() => {
              window.location.href = result.redirectUrl;
            }, 1500);
          } else {
            showStatusMessage(`Falha na Submissão: ${result.message}`, "error");
          }
        } catch (error) {
          console.error("Erro na comunicação com a API de verificação:", error);
          showStatusMessage(
            "Erro ao submeter a chave. Verifique sua conexão.",
            "error"
          );
        }
      }

      window.onload = () => {
        fetchPrivateData();
      };
    </script>
  </body>
</html>
